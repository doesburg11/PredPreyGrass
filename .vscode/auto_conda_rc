# Auto-generated rc to enforce project conda env
# Source the user's default bashrc for conda functions
if [ -f ~/.bashrc ]; then
  source ~/.bashrc
fi

# Desired project prefix
PROJECT_PREFIX="/home/doesburg/Projects/PredPreyGrass/.conda"

# Function to ensure activation
_ensure_project_env() {
  # Avoid recursive storms
  if [ -n "${_PREDPREY_REENTER}" ]; then
    return 0
  fi
  export _PREDPREY_REENTER=1

  # If CONDA_PREFIX empty or points to base or different prefix -> reactivate
  if [ -z "${CONDA_PREFIX}" ] || [ "${CONDA_PREFIX}" = "$(conda info --base 2>/dev/null)" ] || [ "${CONDA_PREFIX}" != "${PROJECT_PREFIX}" ]; then
    if command -v conda >/dev/null 2>&1; then
      prev="${CONDA_PREFIX}"
      conda activate "${PROJECT_PREFIX}" >/dev/null 2>&1
      if [ "${CONDA_PREFIX}" != "${PROJECT_PREFIX}" ]; then
        echo "[auto_conda_rc][WARN] Attempted re-activation failed (prev='${prev}', now='${CONDA_PREFIX}')" >&2
      else
        if [ "${prev}" != "${PROJECT_PREFIX}" ]; then
          echo "[auto_conda_rc] Re-activated project env (was '${prev:-none}', now '${CONDA_PREFIX}')" >&2
        fi
      fi
    fi
  fi

  # Also handle mamba if available and conda failed
  if [ "${CONDA_PREFIX}" != "${PROJECT_PREFIX}" ] && command -v mamba >/dev/null 2>&1; then
    prev="${CONDA_PREFIX}"
    mamba activate "${PROJECT_PREFIX}" >/dev/null 2>&1 || true
    if [ "${CONDA_PREFIX}" = "${PROJECT_PREFIX}" ] && [ "${prev}" != "${PROJECT_PREFIX}" ]; then
      echo "[auto_conda_rc] Mamba re-activated project env (was '${prev:-none}')" >&2
    fi
  fi

  unset _PREDPREY_REENTER
}

# First-time ensure
_ensure_project_env

# Hook into PROMPT_COMMAND so any accidental 'conda deactivate' is reverted automatically
case ":${PROMPT_COMMAND}:" in
  *:_ensure_project_env:*) ;;
  *) export PROMPT_COMMAND="_ensure_project_env; ${PROMPT_COMMAND}" ;; 
esac

# Export PYTHONPATH safety again (in case terminal settings missed)
case ":${PYTHONPATH}:" in
  *:/home/doesburg/Projects/PredPreyGrass/src:*) ;;
  *) export PYTHONPATH="/home/doesburg/Projects/PredPreyGrass/src:${PYTHONPATH}" ;;
esac

# Provide a helper command to show current env quickly
ppg_where() { echo "PROJECT_CONDA_PREFIX=${PROJECT_PREFIX}"; echo "CONDA_PREFIX=${CONDA_PREFIX}"; which python; python -V; }
